# horiz-pkg コマンド リファレンス

`horiz-pkg` は HorizOS のユーザーランドにおける中核的なパッケージマネージャー兼ダウンローダーである。依存ライブラリを一切持たない（Zero-Dependency）設計でありながら、独自の TLS 1.3 クライアントを内蔵しており、安全にパッケージをダウンロード・検証・インストールすることができる。

## 基本的な利用方法

通常、シェル（`horiz-sh`）からの手動実行や、初期化スクリプトでの自動実行によってパッケージを取得する。

### 標準的なインストール

```bash
horiz-pkg -u https://example.com/myapp.bin -n myapp -p /bin/pkg.pub
```

このコマンドは以下の動作を行う：

1. `https://example.com/myapp.bin` へ TLS 1.3 セキュア接続を行う。
2. サーバー証明書の正当性をシステムのデフォルトトラストストア (`/etc/horiz/certs.pem`) を元に検証する。
3. ダウンロードしたバイナリの整合性を確認する。
4. 同時に `https://example.com/myapp.bin.sig` から署名ファイルをダウンロードする。
5. `-p` で指定された公開鍵 (`/bin/pkg.pub`) を用いて Ed25519 署名を検証する。
6. 全ての検証に成功した場合、TOCTOU (Time-of-Check to Time-of-Use) 攻撃を防ぐため、一時ファイルに書き出してからアトミックに `/bin/myapp` (`-n myapp` の場合) へとリネーム（配置）する。

## オプション引数

- `-u`, `--url <URL>`
  - ダウンロードするパッケージバイナリのURLを指定する。
  - `https://` を指定した場合のみ、内蔵のTLSクライアントによる通信の暗号化とサーバー認証が行われる。
- `-n`, `--name <NAME>`
  - 保存先のバイナリ名を指定する。
  - 例として `-n myapp` と指定した場合、最終的にファイルは `/bin/myapp` として配置される。
  - セキュリティ対策のため、名前に `/`, `\`, `..` が含まれるパストラバーサルと疑われる指定は即座に拒否される。
- `-p`, `--pubkey <PATH>`
  - パッケージの正当性を検証するための Ed25519 公開鍵ファイルのパスを指定する。
  - システム提供の公式パッケージであれば、通常は `/bin/pkg.pub` などのシステム鍵が使用される。
- `--trust <CA_PEM_PATH>`
  - TLSのサーバー証明書を検証するためのルート証明書群（トラストストア）のパスを指定する。

## トラストストアと独自CAの運用 (--trustオプション)

`horiz-pkg` が HTTPS 通信を行う際、接続先のサーバーが正当なものであるかを証明書チェーンを元に検証し、中間者攻撃 (MITM) を防止する。

- **デフォルトの挙動**: `--trust` オプションを省略した場合、システムは自動的に `/etc/horiz/certs.pem` を信頼済みルート証明書として読み込む。
- **カスタムトラストストアの指定**: 独自のオレオレ証明書（プライベートCA）などを使用して社内や専用のサーバーからパッケージをダウンロードしたい場合、そのルート証明書（PEM形式）を任意のパスに配置し、以下の例のように指定する。

```bash
# カスタムCA証明書を用いた安全なダウンロード
horiz-pkg -u https://private-repo.local/tool.bin -n tool -p /bin/pkg.pub --trust /mnt/usb/my_custom_ca.pem
```

これにより、システム全体の設定（`/etc/horiz/certs.pem`）を汚染することなく、特定のダウンロードコマンドにおいてのみ別途指定したCAを信頼して安全な通信・検証を行うことが可能となる。
