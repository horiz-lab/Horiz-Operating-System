# horiz-init (初期化システム)

`horiz-init` は、HorizOS のユーザーランドにおける最初期プロセス（PID 1相当）として動作し、システムのセットアップとユーザーセッションの管理、および重要指標の監視を行うカスタム実装の Init システムです。

## 主な役割と機能

### 1. 仮想ファイルシステム (VFS) のマウント

システムの動作に必要な仮想ファイルシステムをセキュアなフラグ付きでマウントします。

- **マウント対象**: `/proc`, `/sys`, `/dev`, `/tmp`
- **セキュリティフラグ**: `MS_NOSUID`, `MS_NODEV`, `MS_NOEXEC` 等を付与し、これらの領域からの権限昇格や不正プログラムの実行を防ぎます。

### 2. インターフェースの初期化

ネットワークのループバックインターフェース (`lo`) などをセットアップし、コンテナ内やWSL2環境内での最低限のネットワーク通信基盤を準備します。

### 3. セキュアなログインと特権放棄

- ブート完了後、コンソールに `--- HorizOS Login ---` プロンプトを表示します。
- 入力されたパスワードは `horiz-auth` クレートを利用して検証します（10,000回の SHA-256 ストレッチングと定数時間比較によるタイミング攻撃対策）。
- 認証成功後、`/etc/passwd` からユーザーの UID/GID を取得し、子プロセスをフォークします。
- 子プロセスは `setgid` および `setuid` を直ちに実行して root 特権を放棄し、指定ユーザーの権限で標準シェル (`/bin/sh` -> 実際は `horiz-sh`) を起動します。

### 4. 常駐監視とゾンビプロセスの回収

親プロセスとして無限ループで待機し、定期的に `waitpid` を呼び出して終了した子プロセスのリソースを回収します。また、シェルセッションが終了した場合は再びログインプロンプトを表示します。

### 5. 構造化監査ロギング

- システムの重要なイベント（マウント状況、認証の成功・失敗、セッション終了）を `/var/log/system.log` および `/var/log/audit.log` にタイムスタンプ付きで出力します。
- ログ書き込み前にシンボリックリンクチェックを行い、権限を悪用した任意のファイル上書き（シンボリックリンク攻撃）を防止します。
