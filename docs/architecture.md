# HorizOS アーキテクチャ構成

HorizOS は、外部依存を極限まで排除した「Zero-Dependency」な純粋 UNIX 系 OS として設計されている。

## システム全体像

### 1. カーネル (Kernel)

- **ベースライン**: Linux Kernel (バージョンは `build_config.ini` に準拠)
- **特徴**: 主要アーキテクチャ (x86_64, aarch64, riscv64, powerpc64le, s390x, mips64el) に対応し、要求アーキテクチャに応じて都度ソースコードからビルドされる。`defconfig`による軽量な構成をベースとしている。
- **メモリ管理**: 標準のLinuxカーネル機構を利用しつつ、ユーザーランド側での動的リンク排除により、ライブラリロードに伴う余分なオーバーヘッドやメモリ断片化を最小化している。

### 2. ユーザーランド (Horiz Core)

- **開発言語**: Rust (Musl libc を用いた完全静的リンク)
- **外部依存排除**: OpenSSL、curl、BusyBox といった外部ライブラリ・ツール群に一切依存せず、以下の機能をすべて自前で実装・提供している。
  - ルートプロセス (`horiz-init`)
  - パッケージおよびアップデート管理 (`horiz-pkg`)
  - ユーザーシェル (`horiz-sh`)
  - 基本コマンド群 (`horiz-utils`)
  - セキュア認証基盤 (`horiz-auth`)

### 3. ファイルシステム (rootfs)

- **構成**: `/bin`, `/etc`, `/var`, `/tmp`, `/dev`, `/proc`, `/sys` などの標準的な UNIX 階層を採用している。
- **配置**: ビルドスクリプトにより FHS に準拠したディレクトリツリーが動的に作成され、そこへ Rust のビルドアーティファクトが直接コピーされて純粋な独自環境を構成する。

## プロセスモデルとライフサイクル

1. **ブートフェーズ**: カーネルがロードを完了すると、初期化プロセスとして `/bin/init` (実体は `horiz-init`) を PID 1 として起動する。
2. **システムセットアップ**: `horiz-init` は、`/proc`, `/sys`, `/dev`, `/tmp` などの仮想ファイルシステムを `MS_NOSUID`, `MS_NOEXEC` を含む厳格なマウントオプションでマウントし、ループバックインターフェースを有効化する。
3. **ユーザー認証**: コンソールにログインプロンプトが表示され、入力された情報は `horiz-auth` (XOR定数時間比較とSHA-256を用いたセキュアな検証) に渡される。
4. **特権放棄とシェル起動**: 認証成功後、`horiz-init` は直ちに `setgid` および `setuid` を発行して特権を放棄した上で子プロセスとして `/bin/sh` (`horiz-sh`) を起動する。
5. **プロセス監視 (Supervision)**: `horiz-init` 本体は無限ループへ入り、死活監視と `waitpid` を介したゾンビプロセスの回収を継続的に行う。シェルが終了した場合は再びログインプロンプトへ回帰する。
